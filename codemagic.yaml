workflows:
  ios_release:
    name: iOS Release → TestFlight
    instance_type: mac_mini_m2

    integrations:
      app_store_connect: "ASC-Sky"   # exact name from Teams → Integrations

    environment:
      flutter: stable
      xcode: latest
      cocoapods: default

    scripts:
      - name: Flutter packages
        script: flutter pub get

      - name: Install cert & provisioning profile from env vars
        script: |
          set -euo pipefail
          # Write files from base64 variables
          echo "$IOS_DIST_CERT_P12_BASE64" | base64 --decode > /tmp/dist.p12
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          echo "$IOS_PROFILE_BASE64" | base64 --decode > "$HOME/Library/MobileDevice/Provisioning Profiles/appstore.mobileprovision"

          # Import .p12 into login keychain
          security import /tmp/dist.p12 -P "${IOS_DIST_CERT_PASSWORD:-}" -A -t cert -f pkcs12 -k "$HOME/Library/Keychains/login.keychain-db"
          # Allow codesign tools to use the key
          security set-key-partition-list -S apple-tool:,apple: -s -k "" "$HOME/Library/Keychains/login.keychain-db"

          # Apply provisioning profile to the Xcode project
          xcode-project use-profiles

          echo "== Signing settings =="
          xcode-project show-build-settings --workspace "ios/Runner.xcworkspace" --scheme "Runner" | egrep "PRODUCT_BUNDLE_IDENTIFIER|DEVELOPMENT_TEAM|PROVISIONING_PROFILE|CODE_SIGN_STYLE"

      - name: Build IPA (Release)
        script: xcode-project build-ipa --workspace "ios/Runner.xcworkspace" --scheme "Runner"

    artifacts:
      - build/ios/ipa/*.ipa

    publishing:
      app_store_connect:
        auth: integration
        submit_to_testflight: true
